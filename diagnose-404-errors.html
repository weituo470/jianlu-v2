<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>404错误诊断工具</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .diagnostic-container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .diagnostic-section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
        }
        .error-section {
            border-left-color: #dc3545;
        }
        .success-section {
            border-left-color: #28a745;
        }
        .resource-item {
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f8f9fa;
        }
        .resource-success {
            background: #d4edda;
            border-color: #c3e6cb;
        }
        .resource-error {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        .resource-loading {
            background: #e2e3e5;
            border-color: #ced4da;
        }
        .status-icon {
            font-size: 20px;
            width: 30px;
            text-align: center;
        }
        .resource-info {
            flex: 1;
            margin: 0 15px;
        }
        .resource-path {
            font-family: monospace;
            font-size: 12px;
            color: #6c757d;
        }
        .btn-test {
            margin: 5px;
        }
        .error-message {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        .code-block {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #495057;
        }
        .stat-label {
            font-size: 14px;
            color: #6c757d;
        }
        .log-entry {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            background: #f8f9fa;
            border-left: 3px solid #007bff;
        }
        .log-error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        .log-success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        .log-warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }
    </style>
</head>
<body>
    <div class="diagnostic-container">
        <h1 class="text-center mb-4">
            <i class="fas fa-search text-danger"></i>
            404错误诊断工具
        </h1>

        <div class="diagnostic-section error-section">
            <h3><i class="fas fa-exclamation-triangle"></i> 404错误分析</h3>
            <div class="error-message">
                <strong>404错误说明：</strong>
                <p>404 Not Found 表示服务器无法找到请求的资源。这通常发生在：</p>
                <ul>
                    <li>📁 资源文件不存在或路径错误</li>
                    <li>🔗 HTML中的引用路径与实际文件路径不匹配</li>
                    <li>🚦 服务器路由配置问题</li>
                    <li>📂 文件被移动或删除</li>
                    <li>⚡ 静态文件中间件配置错误</li>
                </ul>
            </div>
        </div>

        <div class="diagnostic-section">
            <h3><i class="fas fa-list-check"></i> 资源状态检查</h3>
            <p>点击按钮检查活动详情页面的所有资源文件：</p>
            <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-primary" onclick="checkAllResources()">
                    <i class="fas fa-check-double me-2"></i>检查所有资源
                </button>
                <button class="btn btn-success" onclick="checkCSSResources()">
                    <i class="fas fa-css3 me-2"></i>检查CSS文件
                </button>
                <button class="btn btn-info" onclick="checkJSResources()">
                    <i class="fas fa-file-code me-2"></i>检查JS文件
                </button>
                <button class="btn btn-warning" onclick="checkExternalResources()">
                    <i class="fas fa-globe me-2"></i>检查外部资源
                </button>
            </div>
            <div id="resource-status"></div>
        </div>

        <div class="diagnostic-section">
            <h3><i class="fas fa-chart-line"></i> 诊断统计</h3>
            <div id="stats-container" class="stats-grid">
                <!-- 统计信息将在这里显示 -->
            </div>
        </div>

        <div class="diagnostic-section">
            <h3><i class="fas fa-tools"></i> 修复建议</h3>
            <div class="accordion" id="fixAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#fixFileNotFound">
                            文件不存在 (404)
                        </button>
                    </h2>
                    <div id="fixFileNotFound" class="accordion-collapse collapse show" data-bs-parent="#fixAccordion">
                        <div class="accordion-body">
                            <h5>解决方案：</h5>
                            <ol>
                                <li><strong>检查文件是否存在</strong>：确认文件在正确的目录中</li>
                                <li><strong>检查文件名大小写</strong>：确保文件名完全匹配（区分大小写）</li>
                                <li><strong>检查路径格式</strong>：使用正确的相对路径或绝对路径</li>
                            </ol>
                            <div class="code-block">
                                <!-- 正确的路径示例 -->
                                &lt;link href="/css/main.css" rel="stylesheet"&gt;
                                &lt;script src="/js/config.js"&gt;&lt;/script&gt;
                            </div>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#fixServerConfig">
                            服务器配置问题
                        </button>
                    </h2>
                    <div id="fixServerConfig" class="accordion-collapse collapse" data-bs-parent="#fixAccordion">
                        <div class="accordion-body">
                            <h5>检查Express静态文件配置：</h5>
                            <div class="code-block">
                                // 确保静态文件中间件配置正确
                                app.use(express.static(path.join(__dirname, '../../admin-frontend')));

                                // 静态文件应该放在这个目录中
                                // admin-frontend/
                                // ├── css/
                                // ├── js/
                                // └── uploads/
                            </div>
                            <h5>重启服务器</h5>
                            <p>修改配置后需要重启Node.js服务器使更改生效。</p>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#fixCacheIssue">
                            缓存问题
                        </button>
                    </h2>
                    <div id="fixCacheIssue" class="accordion-collapse collapse" data-bs-parent="#fixAccordion">
                        <div class="accordion-body">
                            <h5>清除浏览器缓存：</h5>
                            <ul>
                                <li><strong>硬刷新</strong>：Ctrl+F5 (Windows) 或 Cmd+Shift+R (Mac)</li>
                                <li><strong>清除缓存</strong>：在开发者工具中禁用缓存</li>
                                <li><strong>隐私模式</strong>：使用隐私模式测试</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="diagnostic-section">
            <h3><i class="fas fa-list"></i> 实时日志</h3>
            <button class="btn btn-outline-primary" onclick="clearLog()">
                <i class="fas fa-trash me-2"></i>清除日志
            </button>
            <div id="log-container" style="max-height: 300px; overflow-y: auto; margin-top: 10px;">
                <!-- 日志将在这里显示 -->
            </div>
        </div>
    </div>

    <script>
        // 活动详情页面引用的资源列表
        const resources = {
            css: [
                {
                    name: 'Bootstrap CSS',
                    url: 'https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css',
                    description: 'Bootstrap框架样式表',
                    external: true
                },
                {
                    name: 'Font Awesome CSS',
                    url: 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css',
                    description: 'Font Awesome图标库',
                    external: true
                },
                {
                    name: 'Main CSS',
                    url: '/css/main.css',
                    description: '主要样式表文件',
                    external: false
                }
            ],
            js: [
                {
                    name: 'Bootstrap JS',
                    url: 'https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js',
                    description: 'Bootstrap JavaScript库',
                    external: true
                },
                {
                    name: 'Config JS',
                    url: '/js/config.js',
                    description: '配置文件',
                    external: false
                },
                {
                    name: 'Utils JS',
                    url: '/js/utils.js',
                    description: '工具函数库',
                    external: false
                },
                {
                    name: 'Auth JS',
                    url: '/js/auth.js',
                    description: '认证相关功能',
                    external: false
                },
                {
                    name: 'API JS',
                    url: '/js/api.js',
                    description: 'API调用封装',
                    external: false
                },
                {
                    name: 'Router JS',
                    url: '/js/router.js',
                    description: '路由管理',
                    external: false
                },
                {
                    name: 'Activity Detail Page JS',
                    url: '/js/activity-detail-page.js',
                    description: '活动详情页面逻辑',
                    external: false
                }
            ]
        };

        let stats = {
            total: 0,
            success: 0,
            error: 0,
            loading: 0
        };

        // 检查单个资源
        async function checkResource(resource) {
            const element = document.getElementById(`resource-${resource.url.replace(/[^a-zA-Z0-9]/g, '')}`);
            if (element) {
                element.className = 'resource-item resource-loading';
                element.innerHTML = `
                    <div class="status-icon">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                    <div class="resource-info">
                        <strong>${resource.name}</strong><br>
                        <small class="text-muted">${resource.description}</small>
                        <div class="resource-path">${resource.url}</div>
                    </div>
                    <div class="status-text">
                        检查中...
                    </div>
                `;
            }

            stats.loading++;
            updateStats();

            try {
                const response = await fetch(resource.url, {
                    method: 'HEAD',
                    mode: resource.external ? 'cors' : 'no-cors'
                });

                if (element) {
                    element.className = response.ok ? 'resource-item resource-success' : 'resource-item resource-error';
                    element.innerHTML = `
                        <div class="status-icon">
                            <i class="fas fa-${response.ok ? 'check-circle text-success' : 'times-circle text-danger'}"></i>
                        </div>
                        <div class="resource-info">
                            <strong>${resource.name}</strong><br>
                            <small class="text-muted">${resource.description}</small>
                            <div class="resource-path">${resource.url}</div>
                        </div>
                        <div class="status-text">
                            ${response.ok ?
                                `✅ HTTP ${response.status}` :
                                `❌ HTTP ${response.status} (404 Not Found)`
                            }
                        </div>
                    `;
                }

                if (response.ok) {
                    stats.success++;
                    addLog(`✅ ${resource.name} 加载成功 (${resource.url})`, 'success');
                } else {
                    stats.error++;
                    addLog(`❌ ${resource.name} 加载失败: HTTP ${response.status} (${resource.url})`, 'error');

                    if (response.status === 404) {
                        add404Suggestions(resource);
                    }
                }
            } catch (error) {
                if (element) {
                    element.className = 'resource-item resource-error';
                    element.innerHTML = `
                        <div class="status-icon">
                            <i class="fas fa-exclamation-triangle text-danger"></i>
                        </div>
                        <div class="resource-info">
                            <strong>${resource.name}</strong><br>
                            <small class="text-muted">${resource.description}</small>
                            <div class="resource-path">${resource.url}</div>
                        </div>
                        <div class="status-text">
                            ❌ 请求失败: ${error.message}
                        </div>
                    `;
                }
                stats.error++;
                addLog(`❌ ${resource.name} 请求异常: ${error.message} (${resource.url})`, 'error');
            }

            stats.loading--;
            stats.total++;
            updateStats();
        }

        // 添加404错误建议
        function add404Suggestions(resource) {
            const suggestions = document.createElement('div');
            suggestions.className = 'alert alert-warning alert-dismissible fade show mt-2';
            suggestions.innerHTML = `
                <h6><i class="fas fa-lightbulb"></i> ${resource.name} 404错误修复建议：</h6>
                <ol>
                    <li>确认文件 <code>${resource.url}</code> 是否存在</li>
                    <li>检查文件路径是否正确</li>
                    <li>确认文件名大小写是否匹配</li>
                    <li>检查服务器静态文件配置</li>
                </ol>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            const container = document.getElementById('resource-status');
            if (container) {
                container.appendChild(suggestions);
            }
        }

        // 检查所有资源
        async function checkAllResources() {
            clearLog();
            addLog('🚀 开始检查所有资源...', 'info');

            const allResources = [...resources.css, ...resources.js];

            // 清空状态显示
            document.getElementById('resource-status').innerHTML = '';
            allResources.forEach(resource => {
                const element = document.createElement('div');
                element.id = `resource-${resource.url.replace(/[^a-zA-Z0-9]/g, '')}`;
                document.getElementById('resource-status').appendChild(element);
            });

            // 并行检查所有资源
            await Promise.all(allResources.map(resource => checkResource(resource)));

            addLog(`✅ 资源检查完成: 成功 ${stats.success}/${stats.total} 个`, 'success');
        }

        // 检查CSS资源
        async function checkCSSResources() {
            clearLog();
            addLog('🎨 开始检查CSS资源...', 'info');

            document.getElementById('resource-status').innerHTML = '';
            resources.css.forEach(resource => {
                const element = document.createElement('div');
                element.id = `resource-${resource.url.replace(/[^a-zA-Z0-9]/g, '')}`;
                document.getElementById('resource-status').appendChild(element);
            });

            await Promise.all(resources.css.map(resource => checkResource(resource)));
        }

        // 检查JS资源
        async function checkJSResources() {
            clearLog();
            addLog('📜 开始检查JavaScript资源...', 'info');

            document.getElementById('resource-status').innerHTML = '';
            resources.js.forEach(resource => {
                const element = document.createElement('div');
                element.id = `resource-${resource.url.replace(/[^a-zA-Z0-9]/g, '')}`;
                document.getElementById('resource-status').appendChild(element);
            });

            await Promise.all(resources.js.map(resource => checkResource(resource)));
        }

        // 检查外部资源
        async function checkExternalResources() {
            clearLog();
            addLog('🌐 开始检查外部资源...', 'info');

            const externalResources = [...resources.css, ...resources.js].filter(r => r.external);

            document.getElementById('resource-status').innerHTML = '';
            externalResources.forEach(resource => {
                const element = document.createElement('div');
                element.id = `resource-${resource.url.replace(/[^a-zA-Z0-9]/g, '')}`;
                document.getElementById('resource-status').appendChild(element);
            });

            await Promise.all(externalResources.map(resource => checkResource(resource)));
        }

        // 更新统计信息
        function updateStats() {
            const container = document.getElementById('stats-container');
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.total}</div>
                    <div class="stat-label">总资源数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value text-success">${stats.success}</div>
                    <div class="stat-label">成功</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value text-danger">${stats.error}</div>
                    <div class="stat-label">错误</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value text-warning">${stats.loading}</div>
                    <div class="stat-label">检查中</div>
                </div>
            `;
        }

        // 添加日志
        function addLog(message, type = 'info') {
            const container = document.getElementById('log-container');
            const logClass = type === 'error' ? 'log-error' :
                           type === 'success' ? 'log-success' :
                           type === 'warning' ? 'log-warning' : '';

            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${logClass}`;
            logEntry.innerHTML = `<span>${new Date().toLocaleTimeString()} - ${message}</span>`;

            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
        }

        // 清除日志
        function clearLog() {
            document.getElementById('log-container').innerHTML = '';
            stats = { total: 0, success: 0, error: 0, loading: 0 };
            updateStats();
        }

        // 页面加载完成后自动运行基础检查
        document.addEventListener('DOMContentLoaded', function() {
            addLog('🔧 404错误诊断工具加载完成', 'info');
            addLog('💡 请点击上方按钮开始检查资源状态', 'info');

            // 自动检查当前页面的资源加载情况
            setTimeout(() => {
                const scripts = document.scripts;
                const links = document.styleSheets;

                addLog(`📊 当前页面已加载: ${scripts.length} 个脚本, ${links.length} 个样式表`, 'info');

                // 检查是否有加载失败的资源
                const failedResources = [];
                scripts.forEach(script => {
                    if (!script.src || script.src.includes('localhost:3460')) {
                        // 这是一个本地资源，检查是否加载失败
                        if (!script.onload && !script.onerror) {
                            failedResources.push(script.src);
                        }
                    }
                });

                if (failedResources.length > 0) {
                    addLog(`⚠️ 检测到 ${failedResources.length} 个可能失败的本地资源`, 'warning');
                    failedResources.forEach(src => {
                        addLog(`   - ${src}`, 'warning');
                    });
                }
            }, 1000);
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>