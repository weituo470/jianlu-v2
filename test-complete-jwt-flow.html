<!DOCTYPE html>
<html>
<head>
    <title>å®Œæ•´JWTæµç¨‹æµ‹è¯•</title>
</head>
<body>
    <h1>å®Œæ•´JWTæµç¨‹æµ‹è¯•</h1>
    <button onclick="testCompleteFlow()">æµ‹è¯•å®Œæ•´æµç¨‹</button>
    <div id="result"></div>

    <script>
        function log(msg) {
            document.getElementById('result').innerHTML += '<p>' + msg + '</p>';
        }
        
        async function testCompleteFlow() {
            document.getElementById('result').innerHTML = '';
            log('=== å®Œæ•´JWTæµç¨‹æµ‹è¯• ===');
            
            try {
                // 1. æ¸…é™¤ç°æœ‰æ•°æ®
                log('1. æ¸…é™¤ç°æœ‰è®¤è¯æ•°æ®...');
                localStorage.clear();
                
                // 2. æ¨¡æ‹Ÿç™»å½•
                log('2. æ‰§è¡Œç™»å½•...');
                const loginResponse = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });
                
                const loginData = await loginResponse.json();
                if (!loginData.success) {
                    log('âŒ ç™»å½•å¤±è´¥: ' + loginData.message);
                    return;
                }
                
                log('âœ… ç™»å½•æˆåŠŸ');
                const token = loginData.data.token;
                const user = loginData.data.user;
                
                // 3. æ‰‹åŠ¨å­˜å‚¨tokenï¼ˆæ¨¡æ‹Ÿå‰ç«¯å­˜å‚¨ï¼‰
                log('3. å­˜å‚¨è®¤è¯æ•°æ®...');
                localStorage.setItem('token', token);
                localStorage.setItem('admin_user', JSON.stringify(user));
                localStorage.setItem('admin_token_expires', (Date.now() + 24*60*60*1000).toString());
                
                log(`Tokené•¿åº¦: ${token.length}`);
                log(`Tokenæ ¼å¼: ${token.split('.').length === 3 ? 'JWT' : 'éJWT'}`);
                
                // 4. æµ‹è¯•ç›´æ¥APIè°ƒç”¨
                log('4. æµ‹è¯•ç›´æ¥APIè°ƒç”¨...');
                const directResponse = await fetch('/api/teams/types', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                log(`ç›´æ¥è°ƒç”¨çŠ¶æ€: ${directResponse.status}`);
                if (directResponse.ok) {
                    const directData = await directResponse.json();
                    log(`âœ… ç›´æ¥è°ƒç”¨æˆåŠŸï¼Œæ•°æ®é‡: ${directData.data?.length || 0}`);
                } else {
                    const directError = await directResponse.json();
                    log(`âŒ ç›´æ¥è°ƒç”¨å¤±è´¥: ${directError.message}`);
                }
                
                // 5. æµ‹è¯•é€šè¿‡localStorageè·å–token
                log('5. æµ‹è¯•localStorageè·å–...');
                const storedToken = localStorage.getItem('token');
                log(`å­˜å‚¨çš„tokenä¸åŸå§‹tokenç›¸ç­‰: ${storedToken === token}`);
                
                if (storedToken !== token) {
                    log('âš ï¸ Tokenå­˜å‚¨æœ‰é—®é¢˜ï¼');
                    log(`åŸå§‹: ${token.substring(0, 50)}...`);
                    log(`å­˜å‚¨: ${storedToken.substring(0, 50)}...`);
                }
                
                // 6. æµ‹è¯•ä½¿ç”¨å­˜å‚¨çš„tokenè°ƒç”¨API
                log('6. æµ‹è¯•ä½¿ç”¨å­˜å‚¨tokenè°ƒç”¨API...');
                const storedResponse = await fetch('/api/teams/types', {
                    headers: { 'Authorization': 'Bearer ' + storedToken }
                });
                
                log(`å­˜å‚¨tokenè°ƒç”¨çŠ¶æ€: ${storedResponse.status}`);
                if (storedResponse.ok) {
                    const storedData = await storedResponse.json();
                    log(`âœ… å­˜å‚¨tokenè°ƒç”¨æˆåŠŸï¼Œæ•°æ®é‡: ${storedData.data?.length || 0}`);
                } else {
                    const storedError = await storedResponse.json();
                    log(`âŒ å­˜å‚¨tokenè°ƒç”¨å¤±è´¥: ${storedError.message}`);
                }
                
            } catch (error) {
                log(`ğŸ’¥ æµ‹è¯•å¼‚å¸¸: ${error.message}`);
            }
        }
    </script>
</body>
</html>