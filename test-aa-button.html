<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•AAæ´»åŠ¨æŒ‰é’®</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Microsoft YaHei', sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; margin-bottom: 30px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; }
        .result { margin: 15px 0; padding: 15px; border-radius: 4px; white-space: pre-wrap; font-family: monospace; font-size: 12px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .btn { margin: 10px 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª AAæ´»åŠ¨æŒ‰é’®æµ‹è¯•</h1>
        
        <div class="test-section">
            <h3>æµ‹è¯•æ­¥éª¤</h3>
            <ol>
                <li>ç‚¹å‡»"åŠ è½½AAæ´»åŠ¨è„šæœ¬"</li>
                <li>ç‚¹å‡»"æµ‹è¯•AAæ´»åŠ¨åŠŸèƒ½"</li>
                <li>æ£€æŸ¥æ˜¯å¦å¼¹å‡ºAAæ´»åŠ¨åˆ›å»ºçª—å£</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>æµ‹è¯•æŒ‰é’®</h3>
            <button class="btn btn-primary" onclick="loadAAScript()">1. åŠ è½½AAæ´»åŠ¨è„šæœ¬</button>
            <button class="btn btn-success" onclick="testAAFunction()">2. æµ‹è¯•AAæ´»åŠ¨åŠŸèƒ½</button>
            <button class="btn btn-warning" onclick="checkDependencies()">3. æ£€æŸ¥ä¾èµ–</button>
            <div id="testResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>æ¨¡æ‹ŸåŸå§‹æŒ‰é’®</h3>
            <p>è¿™ä¸ªæŒ‰é’®ä¸æ´»åŠ¨åˆ—è¡¨é¡µé¢çš„ç»¿è‰²æŒ‰é’®åŠŸèƒ½å®Œå…¨ç›¸åŒï¼š</p>
            <button class="btn btn-success" onclick="window.showAAActivityModal()" style="height: 36px; white-space: nowrap;">
                <i class="fas fa-money-bill-wave"></i>
                åˆ›å»ºAAæ´»åŠ¨ (æµ‹è¯•)
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/config.js"></script>
    <script src="/js/api.js"></script>

    <script>
        function showResult(data, isError = false) {
            const element = document.getElementById('testResult');
            element.textContent = JSON.stringify(data, null, 2);
            element.className = `result ${isError ? 'error' : 'success'}`;
        }

        function showInfo(message) {
            const element = document.getElementById('testResult');
            element.textContent = message;
            element.className = 'result info';
        }

        async function loadAAScript() {
            showInfo('æ­£åœ¨åŠ è½½AAæ´»åŠ¨è„šæœ¬...');
            try {
                // åŠ è½½AAæ´»åŠ¨ç®¡ç†å™¨è„šæœ¬
                const script = document.createElement('script');
                script.src = '/js/aa-activity-manager.js?t=' + Date.now();
                script.onload = () => {
                    showResult({ 
                        message: 'âœ… AAæ´»åŠ¨è„šæœ¬åŠ è½½æˆåŠŸ',
                        showAAActivityModal: typeof window.showAAActivityModal === 'function' ? 'âœ… å·²å®šä¹‰' : 'âŒ æœªå®šä¹‰',
                        calculateAACosts: typeof window.calculateAACosts === 'function' ? 'âœ… å·²å®šä¹‰' : 'âŒ æœªå®šä¹‰',
                        submitAAActivity: typeof window.submitAAActivity === 'function' ? 'âœ… å·²å®šä¹‰' : 'âŒ æœªå®šä¹‰'
                    });
                };
                script.onerror = () => {
                    showResult({ error: 'âŒ AAæ´»åŠ¨è„šæœ¬åŠ è½½å¤±è´¥' }, true);
                };
                document.head.appendChild(script);
            } catch (error) {
                showResult({ error: error.message }, true);
            }
        }

        async function testAAFunction() {
            showInfo('æ­£åœ¨æµ‹è¯•AAæ´»åŠ¨åŠŸèƒ½...');
            try {
                if (typeof window.showAAActivityModal !== 'function') {
                    showResult({ error: 'âŒ showAAActivityModal å‡½æ•°ä¸å­˜åœ¨ï¼Œè¯·å…ˆåŠ è½½è„šæœ¬' }, true);
                    return;
                }

                console.log('ğŸ¯ è°ƒç”¨ showAAActivityModal()');
                await window.showAAActivityModal();
                
                showResult({ 
                    message: 'âœ… AAæ´»åŠ¨åŠŸèƒ½è°ƒç”¨æˆåŠŸï¼è¯·æ£€æŸ¥æ˜¯å¦å¼¹å‡ºäº†æ¨¡æ€æ¡†'
                });
            } catch (error) {
                showResult({ error: 'âŒ æµ‹è¯•å¤±è´¥: ' + error.message }, true);
                console.error('æµ‹è¯•é”™è¯¯:', error);
            }
        }

        async function checkDependencies() {
            showInfo('æ­£åœ¨æ£€æŸ¥ä¾èµ–...');
            
            const dependencies = {
                bootstrap: typeof bootstrap !== 'undefined' ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½',
                API: typeof API !== 'undefined' ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½',
                AppConfig: typeof AppConfig !== 'undefined' ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½',
                jQuery: typeof $ !== 'undefined' ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½',
            };

            // æµ‹è¯•APIè°ƒç”¨
            try {
                if (typeof API !== 'undefined' && API.teams) {
                    const teamsResponse = await API.teams.getList();
                    dependencies.teamsAPI = teamsResponse.success ? 'âœ… æ­£å¸¸' : 'âŒ å¤±è´¥: ' + teamsResponse.message;
                } else {
                    dependencies.teamsAPI = 'âŒ API.teams ä¸å­˜åœ¨';
                }
            } catch (error) {
                dependencies.teamsAPI = 'âŒ é”™è¯¯: ' + error.message;
            }

            try {
                if (typeof API !== 'undefined' && API.activities) {
                    const typesResponse = await API.activities.getTypes();
                    dependencies.activitiesAPI = typesResponse.success ? 'âœ… æ­£å¸¸' : 'âŒ å¤±è´¥: ' + typesResponse.message;
                } else {
                    dependencies.activitiesAPI = 'âŒ API.activities ä¸å­˜åœ¨';
                }
            } catch (error) {
                dependencies.activitiesAPI = 'âŒ é”™è¯¯: ' + error.message;
            }

            showResult(dependencies);
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æŸ¥ä¾èµ–
        window.addEventListener('load', function() {
            showInfo('é¡µé¢åŠ è½½å®Œæˆï¼Œç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•');
        });
    </script>
</body>
</html>