<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试AA活动按钮</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Microsoft YaHei', sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; margin-bottom: 30px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; }
        .result { margin: 15px 0; padding: 15px; border-radius: 4px; white-space: pre-wrap; font-family: monospace; font-size: 12px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .btn { margin: 10px 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 AA活动按钮测试</h1>
        
        <div class="test-section">
            <h3>测试步骤</h3>
            <ol>
                <li>点击"加载AA活动脚本"</li>
                <li>点击"测试AA活动功能"</li>
                <li>检查是否弹出AA活动创建窗口</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>测试按钮</h3>
            <button class="btn btn-primary" onclick="loadAAScript()">1. 加载AA活动脚本</button>
            <button class="btn btn-success" onclick="testAAFunction()">2. 测试AA活动功能</button>
            <button class="btn btn-warning" onclick="checkDependencies()">3. 检查依赖</button>
            <div id="testResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>模拟原始按钮</h3>
            <p>这个按钮与活动列表页面的绿色按钮功能完全相同：</p>
            <button class="btn btn-success" onclick="window.showAAActivityModal()" style="height: 36px; white-space: nowrap;">
                <i class="fas fa-money-bill-wave"></i>
                创建AA活动 (测试)
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/config.js"></script>
    <script src="/js/api.js"></script>

    <script>
        function showResult(data, isError = false) {
            const element = document.getElementById('testResult');
            element.textContent = JSON.stringify(data, null, 2);
            element.className = `result ${isError ? 'error' : 'success'}`;
        }

        function showInfo(message) {
            const element = document.getElementById('testResult');
            element.textContent = message;
            element.className = 'result info';
        }

        async function loadAAScript() {
            showInfo('正在加载AA活动脚本...');
            try {
                // 加载AA活动管理器脚本
                const script = document.createElement('script');
                script.src = '/js/aa-activity-manager.js?t=' + Date.now();
                script.onload = () => {
                    showResult({ 
                        message: '✅ AA活动脚本加载成功',
                        showAAActivityModal: typeof window.showAAActivityModal === 'function' ? '✅ 已定义' : '❌ 未定义',
                        calculateAACosts: typeof window.calculateAACosts === 'function' ? '✅ 已定义' : '❌ 未定义',
                        submitAAActivity: typeof window.submitAAActivity === 'function' ? '✅ 已定义' : '❌ 未定义'
                    });
                };
                script.onerror = () => {
                    showResult({ error: '❌ AA活动脚本加载失败' }, true);
                };
                document.head.appendChild(script);
            } catch (error) {
                showResult({ error: error.message }, true);
            }
        }

        async function testAAFunction() {
            showInfo('正在测试AA活动功能...');
            try {
                if (typeof window.showAAActivityModal !== 'function') {
                    showResult({ error: '❌ showAAActivityModal 函数不存在，请先加载脚本' }, true);
                    return;
                }

                console.log('🎯 调用 showAAActivityModal()');
                await window.showAAActivityModal();
                
                showResult({ 
                    message: '✅ AA活动功能调用成功！请检查是否弹出了模态框'
                });
            } catch (error) {
                showResult({ error: '❌ 测试失败: ' + error.message }, true);
                console.error('测试错误:', error);
            }
        }

        async function checkDependencies() {
            showInfo('正在检查依赖...');
            
            const dependencies = {
                bootstrap: typeof bootstrap !== 'undefined' ? '✅ 已加载' : '❌ 未加载',
                API: typeof API !== 'undefined' ? '✅ 已加载' : '❌ 未加载',
                AppConfig: typeof AppConfig !== 'undefined' ? '✅ 已加载' : '❌ 未加载',
                jQuery: typeof $ !== 'undefined' ? '✅ 已加载' : '❌ 未加载',
            };

            // 测试API调用
            try {
                if (typeof API !== 'undefined' && API.teams) {
                    const teamsResponse = await API.teams.getList();
                    dependencies.teamsAPI = teamsResponse.success ? '✅ 正常' : '❌ 失败: ' + teamsResponse.message;
                } else {
                    dependencies.teamsAPI = '❌ API.teams 不存在';
                }
            } catch (error) {
                dependencies.teamsAPI = '❌ 错误: ' + error.message;
            }

            try {
                if (typeof API !== 'undefined' && API.activities) {
                    const typesResponse = await API.activities.getTypes();
                    dependencies.activitiesAPI = typesResponse.success ? '✅ 正常' : '❌ 失败: ' + typesResponse.message;
                } else {
                    dependencies.activitiesAPI = '❌ API.activities 不存在';
                }
            } catch (error) {
                dependencies.activitiesAPI = '❌ 错误: ' + error.message;
            }

            showResult(dependencies);
        }

        // 页面加载完成后自动检查依赖
        window.addEventListener('load', function() {
            showInfo('页面加载完成，点击按钮开始测试');
        });
    </script>
</body>
</html>