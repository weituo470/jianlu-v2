<!DOCTYPE html>
<html>
<head>
    <title>Utils.storage测试</title>
</head>
<body>
    <h1>Utils.storage测试</h1>
    <button onclick="testStorage()">测试存储</button>
    <div id="result"></div>

    <script>
        // 复制Utils.storage的实现
        const Utils = {
            storage: {
                set(key, value) {
                    try {
                        // 特殊处理：token是纯字符串，直接存储
                        if (key === 'token' || key.includes('token')) {
                            localStorage.setItem(key, value);
                        } else {
                            // 其他数据JSON序列化存储
                            localStorage.setItem(key, JSON.stringify(value));
                        }
                        return true;
                    } catch (error) {
                        console.error('Storage set error:', error);
                        return false;
                    }
                },
                
                get(key, defaultValue = null) {
                    try {
                        const item = localStorage.getItem(key);
                        if (!item) return defaultValue;
                        
                        // 特殊处理：token是纯字符串，不需要JSON解析
                        if (key === 'token' || key.includes('token')) {
                            return item;
                        }
                        
                        // 其他数据尝试JSON解析
                        try {
                            return JSON.parse(item);
                        } catch (parseError) {
                            // 如果JSON解析失败，返回原始字符串
                            console.warn('JSON解析失败，返回原始值:', key, parseError.message);
                            return item;
                        }
                    } catch (error) {
                        console.error('Storage get error:', error);
                        return defaultValue;
                    }
                }
            }
        };
        
        function log(msg) {
            document.getElementById('result').innerHTML += '<p>' + msg + '</p>';
        }
        
        function testStorage() {
            document.getElementById('result').innerHTML = '';
            log('=== Utils.storage测试 ===');
            
            // 测试token存储
            const testToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.test.signature';
            
            log('1. 存储token...');
            Utils.storage.set('token', testToken);
            
            log('2. 读取token...');
            const retrievedToken = Utils.storage.get('token');
            
            log(`原始token: ${testToken}`);
            log(`读取token: ${retrievedToken}`);
            log(`是否相等: ${testToken === retrievedToken}`);
            
            // 检查localStorage中的实际值
            const rawValue = localStorage.getItem('token');
            log(`localStorage原始值: ${rawValue}`);
            log(`与原始token相等: ${rawValue === testToken}`);
            
            // 测试其他数据
            log('\\n3. 测试用户数据...');
            const testUser = { username: 'admin', role: 'super_admin' };
            Utils.storage.set('admin_user', testUser);
            const retrievedUser = Utils.storage.get('admin_user');
            log(`用户数据存储成功: ${JSON.stringify(retrievedUser) === JSON.stringify(testUser)}`);
        }
    </script>
</body>
</html>