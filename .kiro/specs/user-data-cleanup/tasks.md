# ç”¨æˆ·æ•°æ®æ¸…ç†ä»»åŠ¡æ¸…å•

## ğŸ“‹ é—®é¢˜è§£å†³æ–¹æ¡ˆ

### é—®é¢˜æè¿°
- åˆ›å»ºç”¨æˆ·æ—¶æç¤º"ç”¨æˆ·åå·²å­˜åœ¨"ï¼Œä½†åœ¨ç®¡ç†åå°ç”¨æˆ·åˆ—è¡¨ä¸­çœ‹ä¸åˆ°è¯¥ç”¨æˆ·
- ç”¨æˆ·è¡¨ä¸­å­˜åœ¨çŠ¶æ€ä¸º `deleted` çš„è„æ•°æ®å ç”¨ç”¨æˆ·å

### è§£å†³æ–¹æ¡ˆ
æä¾›å¤šç§å·¥å…·æ¥è¯Šæ–­å’Œæ¸…ç†ç”¨æˆ·æ•°æ®ä¸­çš„è„æ•°æ®

## ğŸ› ï¸ å¯ç”¨å·¥å…·

### 1. å‘½ä»¤è¡Œè¯Šæ–­å·¥å…·
**æ–‡ä»¶**: `backend/diagnose-user-data.js`

**ä½¿ç”¨æ–¹æ³•**:
```bash
# å®Œæ•´è¯Šæ–­
cd backend
node diagnose-user-data.js check

# æ£€æŸ¥ç‰¹å®šç”¨æˆ·å
node diagnose-user-data.js check admin1

# æ¸…ç†è„æ•°æ®ï¼ˆé¢„æ¼”æ¨¡å¼ï¼‰
node diagnose-user-data.js cleanup --dry-run

# æ‰§è¡Œæ¸…ç†
node diagnose-user-data.js cleanup
```

**åŠŸèƒ½ç‰¹æ€§**:
- âœ… ç”¨æˆ·çŠ¶æ€ç»Ÿè®¡
- âœ… é‡å¤ç”¨æˆ·åæ£€æŸ¥
- âœ… è„æ•°æ®è¯†åˆ«
- âœ… å®‰å…¨æ¸…ç†æ“ä½œ
- âœ… è‡ªåŠ¨å¤‡ä»½

### 2. Webç•Œé¢è¯Šæ–­å·¥å…·
**æ–‡ä»¶**: `test-user-data-cleanup.html`

**ä½¿ç”¨æ–¹æ³•**:
1. åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ `test-user-data-cleanup.html`
2. è‡ªåŠ¨ç™»å½•ç®¡ç†å‘˜è´¦å·
3. ä½¿ç”¨å„ç§è¯Šæ–­å’Œæ¸…ç†åŠŸèƒ½

**åŠŸèƒ½ç‰¹æ€§**:
- ğŸ“Š æ•°æ®ç»Ÿè®¡æ¦‚è§ˆ
- ğŸ” ç‰¹å®šç”¨æˆ·åæ£€æŸ¥
- ğŸ§¹ è„æ•°æ®è¯Šæ–­
- ğŸ‘¥ æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·ï¼ˆåŒ…æ‹¬å·²åˆ é™¤ï¼‰
- ğŸ—‘ï¸ å®‰å…¨æ•°æ®æ¸…ç†
- ğŸ§ª æµ‹è¯•ç”¨æˆ·åˆ›å»º

### 3. å¿«é€Ÿæ¸…ç†è„šæœ¬
**æ–‡ä»¶**: `backend/quick-cleanup-admin1.js`

**ä½¿ç”¨æ–¹æ³•**:
```bash
cd backend
node quick-cleanup-admin1.js
```

**åŠŸèƒ½ç‰¹æ€§**:
- ğŸ¯ ä¸“é—¨æ¸…ç†admin1ç”¨æˆ·çš„è„æ•°æ®
- ğŸ’¾ è‡ªåŠ¨åˆ›å»ºå¤‡ä»½
- âš¡ å¿«é€Ÿæ‰§è¡Œ

## ğŸ“ æ‰§è¡Œæ­¥éª¤

### æ­¥éª¤1ï¼šè¯Šæ–­é—®é¢˜
```bash
# ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·è¯Šæ–­
cd backend
node diagnose-user-data.js check admin1
```

æˆ–è€…æ‰“å¼€ `test-user-data-cleanup.html` åœ¨Webç•Œé¢ä¸­æ£€æŸ¥ã€‚

### æ­¥éª¤2ï¼šæ¸…ç†è„æ•°æ®
å¦‚æœå‘ç°è„æ•°æ®ï¼Œå¯ä»¥é€‰æ‹©ä»¥ä¸‹æ–¹å¼ä¹‹ä¸€ï¼š

**æ–¹å¼1ï¼šä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·**
```bash
# é¢„è§ˆæ¸…ç†æ“ä½œ
node diagnose-user-data.js cleanup --dry-run

# æ‰§è¡Œæ¸…ç†
node diagnose-user-data.js cleanup
```

**æ–¹å¼2ï¼šä½¿ç”¨Webç•Œé¢**
1. æ‰“å¼€ `test-user-data-cleanup.html`
2. ç‚¹å‡»"è¯Šæ–­è„æ•°æ®"
3. ç‚¹å‡»"é¢„è§ˆæ¸…ç†æ“ä½œ"
4. ç‚¹å‡»"æ‰§è¡Œæ¸…ç†"

**æ–¹å¼3ï¼šå¿«é€Ÿæ¸…ç†admin1**
```bash
node quick-cleanup-admin1.js
```

### æ­¥éª¤3ï¼šéªŒè¯ç»“æœ
æ¸…ç†å®Œæˆåï¼Œæµ‹è¯•åˆ›å»ºç”¨æˆ·ï¼š

**å‘½ä»¤è¡ŒéªŒè¯**:
```bash
node diagnose-user-data.js check admin1
```

**Webç•Œé¢éªŒè¯**:
åœ¨ `test-user-data-cleanup.html` ä¸­ä½¿ç”¨"æµ‹è¯•ç”¨æˆ·åˆ›å»º"åŠŸèƒ½ã€‚

## âš ï¸ å®‰å…¨æ³¨æ„äº‹é¡¹

### æ•°æ®å¤‡ä»½
- æ‰€æœ‰æ¸…ç†æ“ä½œéƒ½ä¼šè‡ªåŠ¨åˆ›å»ºå¤‡ä»½
- å¤‡ä»½æ–‡ä»¶ä¿å­˜åœ¨å½“å‰ç›®å½•
- æ ¼å¼ï¼š`*_cleanup_backup_*.json`

### æƒé™è¦æ±‚
- éœ€è¦ç®¡ç†å‘˜æƒé™æ‰§è¡Œæ¸…ç†æ“ä½œ
- Webå·¥å…·éœ€è¦å…ˆç™»å½•ç®¡ç†å‘˜è´¦å·

### æ“ä½œç¡®è®¤
- æ¸…ç†æ“ä½œä¸å¯é€†
- æ‰§è¡Œå‰ä¼šè¦æ±‚ç¡®è®¤
- å»ºè®®å…ˆä½¿ç”¨é¢„æ¼”æ¨¡å¼

## ğŸ”§ æŠ€æœ¯å®ç°

### è„æ•°æ®è¯†åˆ«é€»è¾‘
```javascript
// æŸ¥æ‰¾å·²åˆ é™¤ä½†å ç”¨ç”¨æˆ·åçš„è®°å½•
const deletedUsers = await User.findAll({
    where: { status: 'deleted' }
});

// æ£€æŸ¥æ˜¯å¦æœ‰åŒåçš„æ´»è·ƒç”¨æˆ·
for (const deletedUser of deletedUsers) {
    const activeUser = await User.findOne({
        where: {
            username: deletedUser.username,
            status: { [Op.ne]: 'deleted' }
        }
    });
    
    if (!activeUser) {
        // è¿™æ˜¯è„æ•°æ®ï¼Œå¯ä»¥å®‰å…¨æ¸…ç†
        dirtyData.push(deletedUser);
    }
}
```

### å®‰å…¨æ¸…ç†æµç¨‹
1. **å¤‡ä»½æ•°æ®** - åˆ›å»ºJSONå¤‡ä»½æ–‡ä»¶
2. **äº‹åŠ¡å¤„ç†** - ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ç¡®ä¿ä¸€è‡´æ€§
3. **æ‰¹é‡åˆ é™¤** - ç‰©ç†åˆ é™¤å·²æ ‡è¯†çš„è„æ•°æ®
4. **ç»“æœéªŒè¯** - ç¡®è®¤æ¸…ç†ç»“æœ

## ğŸ“Š é¢„æœŸæ•ˆæœ

### æ¸…ç†å‰
- åˆ›å»ºadmin1ç”¨æˆ·å¤±è´¥ï¼Œæç¤º"ç”¨æˆ·åå·²å­˜åœ¨"
- ç”¨æˆ·åˆ—è¡¨ä¸­çœ‹ä¸åˆ°admin1ç”¨æˆ·
- æ•°æ®åº“ä¸­å­˜åœ¨status='deleted'çš„admin1è®°å½•

### æ¸…ç†å
- admin1ç”¨æˆ·åå¯ä»¥æ­£å¸¸åˆ›å»º
- æ•°æ®åº“ä¸­ä¸å†æœ‰å ç”¨ç”¨æˆ·åçš„è„æ•°æ®
- ç”¨æˆ·åˆ—è¡¨æ˜¾ç¤ºæ­£å¸¸

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•ç”¨ä¾‹1ï¼šè¯Šæ–­åŠŸèƒ½
- [ ] èƒ½å¤Ÿæ­£ç¡®ç»Ÿè®¡å„çŠ¶æ€ç”¨æˆ·æ•°é‡
- [ ] èƒ½å¤Ÿè¯†åˆ«é‡å¤ç”¨æˆ·å
- [ ] èƒ½å¤Ÿå‘ç°è„æ•°æ®

### æµ‹è¯•ç”¨ä¾‹2ï¼šæ¸…ç†åŠŸèƒ½
- [ ] èƒ½å¤Ÿå®‰å…¨æ¸…ç†è„æ•°æ®
- [ ] æ¸…ç†åç”¨æˆ·åå¯ä»¥é‡æ–°ä½¿ç”¨
- [ ] å¤‡ä»½æ–‡ä»¶æ­£ç¡®åˆ›å»º

### æµ‹è¯•ç”¨ä¾‹3ï¼šWebç•Œé¢
- [ ] ç•Œé¢åŠŸèƒ½æ­£å¸¸
- [ ] æ•°æ®æ˜¾ç¤ºå‡†ç¡®
- [ ] æ“ä½œæµç¨‹é¡ºç•…

## ğŸ“ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**Q1: æ¸…ç†åä»ç„¶æ— æ³•åˆ›å»ºç”¨æˆ·ï¼Ÿ**
A: æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–çŠ¶æ€çš„åŒåç”¨æˆ·ï¼Œæˆ–è€…é‡å¯åç«¯æœåŠ¡ã€‚

**Q2: å¤‡ä»½æ–‡ä»¶åœ¨å“ªé‡Œï¼Ÿ**
A: å¤‡ä»½æ–‡ä»¶ä¿å­˜åœ¨æ‰§è¡Œè„šæœ¬çš„å½“å‰ç›®å½•ï¼Œæ–‡ä»¶ååŒ…å«æ—¶é—´æˆ³ã€‚

**Q3: å¦‚ä½•æ¢å¤è¯¯åˆ çš„æ•°æ®ï¼Ÿ**
A: ä½¿ç”¨å¤‡ä»½æ–‡ä»¶ä¸­çš„æ•°æ®ï¼Œæ‰‹åŠ¨é‡æ–°æ’å…¥æ•°æ®åº“ã€‚

### ç´§æ€¥æ¢å¤
å¦‚æœè¯¯åˆ äº†é‡è¦æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨å¤‡ä»½æ–‡ä»¶æ¢å¤ï¼š
```javascript
// ä»å¤‡ä»½æ–‡ä»¶æ¢å¤æ•°æ®çš„ç¤ºä¾‹ä»£ç 
const backupData = JSON.parse(fs.readFileSync('backup_file.json'));
for (const userData of backupData) {
    await User.create(userData);
}
```

---

**ä»»åŠ¡çŠ¶æ€**: âœ… å·¥å…·å·²åˆ›å»ºï¼Œå¾…æµ‹è¯•ä½¿ç”¨  
**ä¼˜å…ˆçº§**: é«˜  
**é¢„è®¡è§£å†³æ—¶é—´**: ç«‹å³å¯ç”¨