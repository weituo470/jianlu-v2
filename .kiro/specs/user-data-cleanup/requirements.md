# 用户数据清理需求文档

## 1. 问题描述

### 1.1 当前问题
- 创建用户时提示"用户名已存在"，但在管理后台用户列表中看不到该用户
- 可能存在状态为 `deleted` 或 `inactive` 的脏数据
- 用户列表查询可能只显示 `active` 状态的用户，但创建时检查所有状态

### 1.2 影响范围
- 管理员无法创建某些用户名的账号
- 数据库中存在不一致的数据状态
- 用户体验受到影响

## 2. 功能需求

### 2.1 数据诊断功能

#### 需求 2.1.1: 用户数据状态检查
**用户故事**: 作为系统管理员，我希望能够检查用户表中的数据状态，以便发现和处理脏数据。

**验收标准**:
1. WHEN 管理员执行数据检查 THEN 系统应显示所有状态的用户统计信息
2. WHEN 检查特定用户名 THEN 系统应显示该用户名的所有记录（包括已删除的）
3. WHEN 发现重复用户名 THEN 系统应列出所有相关记录的详细信息

#### 需求 2.1.2: 脏数据识别
**用户故事**: 作为系统管理员，我希望系统能够自动识别脏数据，以便进行清理。

**验收标准**:
1. WHEN 系统检查数据 THEN 应识别状态为 `deleted` 但仍占用用户名的记录
2. WHEN 发现重复邮箱 THEN 系统应标记为需要处理的脏数据
3. WHEN 发现孤立记录 THEN 系统应提供清理建议

### 2.2 数据清理功能

#### 需求 2.2.1: 安全数据清理
**用户故事**: 作为系统管理员，我希望能够安全地清理脏数据，而不影响正常用户。

**验收标准**:
1. WHEN 执行数据清理 THEN 系统应先备份相关数据
2. WHEN 清理已删除用户 THEN 系统应彻底删除状态为 `deleted` 的记录
3. WHEN 清理完成 THEN 系统应提供清理报告

#### 需求 2.2.2: 用户名释放
**用户故事**: 作为系统管理员，我希望能够释放被脏数据占用的用户名，以便重新使用。

**验收标准**:
1. WHEN 用户名被已删除记录占用 THEN 系统应提供释放选项
2. WHEN 释放用户名 THEN 系统应确保不影响其他关联数据
3. WHEN 释放完成 THEN 该用户名应可以重新创建

### 2.3 前端显示优化

#### 需求 2.3.1: 用户列表过滤优化
**用户故事**: 作为管理员，我希望用户列表能够正确显示所有相关用户，包括不同状态的用户。

**验收标准**:
1. WHEN 查看用户列表 THEN 默认应显示 `active` 和 `inactive` 状态的用户
2. WHEN 需要查看已删除用户 THEN 应提供查看选项
3. WHEN 筛选用户状态 THEN 应能够按状态进行筛选

#### 需求 2.3.2: 错误信息优化
**用户故事**: 作为管理员，我希望在创建用户失败时能够获得更详细的错误信息。

**验收标准**:
1. WHEN 用户名已存在 THEN 应显示该用户的当前状态
2. WHEN 邮箱已存在 THEN 应显示冲突用户的基本信息
3. WHEN 创建失败 THEN 应提供解决建议

## 3. 技术需求

### 3.1 数据库查询优化
- 修改用户列表查询逻辑，正确处理不同状态的用户
- 优化用户名和邮箱的唯一性检查逻辑
- 添加数据完整性检查功能

### 3.2 API接口增强
- 添加数据诊断API接口
- 添加数据清理API接口
- 优化现有用户创建和查询接口

### 3.3 前端功能增强
- 添加数据管理工具页面
- 优化用户列表显示逻辑
- 改进错误提示信息

## 4. 安全要求

### 4.1 数据安全
- 数据清理前必须创建备份
- 清理操作需要管理员权限确认
- 记录所有数据清理操作的审计日志

### 4.2 操作安全
- 提供数据恢复机制
- 限制批量删除操作
- 确保清理操作的可逆性

## 5. 验收标准

### 5.1 功能验收
- 能够正确识别和显示所有脏数据
- 能够安全清理无用的已删除用户记录
- 用户创建功能恢复正常
- 用户列表显示准确

### 5.2 性能验收
- 数据诊断操作在10秒内完成
- 数据清理操作不影响正常业务
- 用户列表查询性能不受影响

### 5.3 安全验收
- 所有清理操作都有完整的审计日志
- 数据备份机制工作正常
- 权限控制有效

## 6. 实施计划

### 6.1 第一阶段：诊断工具开发
- 创建数据诊断脚本
- 开发数据状态检查功能
- 实现脏数据识别逻辑

### 6.2 第二阶段：清理工具开发
- 开发安全的数据清理功能
- 实现用户名释放机制
- 添加数据备份和恢复功能

### 6.3 第三阶段：前端优化
- 优化用户列表显示逻辑
- 改进错误提示信息
- 添加数据管理工具界面

### 6.4 第四阶段：测试和部署
- 全面测试所有功能
- 验证数据安全性
- 部署到生产环境

---

**优先级**: 高  
**预计工期**: 3-5天  
**风险评估**: 中等（涉及数据操作，需要谨慎处理）