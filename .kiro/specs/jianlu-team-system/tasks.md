# 简庐团队系统实现任务清单

## 阶段一：用户身份体系重构

- [ ] 1. 扩展用户模型支持简庐身份体系
  - 在User模型中添加member_type字段（P/Q/V三种类型）
  - 实现17位ID生成规则（注册时间年月日时+7位顺序编码）
  - 添加昵称字段（20字节限制，允许重名）
  - 添加手机号验证和身份证号字段
  - 创建数据库迁移脚本
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6_

- [ ] 2. 实现用户类型转换机制
  - 实现亲情会员（Q）升级为普通会员（P）的逻辑
  - 实现普通会员（P）认证为商户会员（V）的流程
  - 添加身份验证和手机号认证功能
  - 编写用户类型转换的API接口
  - _需求: 1.3, 1.4_

## 阶段二：机构管理系统核心架构

- [x] 3. 创建机构数据模型


  - 设计Organization模型替换现有Team模型
  - 创建OrganizationHierarchy模型支持多层级结构
  - 实现机构类型（国家认证/民间团体）和分类标签系统
  - 创建机构成员关系模型OrganizationMember
  - _需求: 2.1, 2.2, 2.3_

- [x] 4. 实现多层级机构结构
  - ✅ 实现一级机构、二级机构、分组的层级关系
  - ✅ 创建机构层级管理的API接口
  - ✅ 实现机构成员统计去重逻辑（基于用户ID）
  - ✅ 添加机构层级查询和管理功能
  - ✅ 创建完整的机构管理API路由
  - ✅ 创建机构成员管理API路由
  - _需求: 2.2, 2.3, 2.4_

## 阶段三：成员管理和加入机制

- [x] 5. 实现机构成员加入方式
  - ✅ 实现邀请加入功能（管理员邀请）
  - ✅ 实现扫码加入功能（生成短期有效二维码）
  - ✅ 实现在线申请功能（用户主动申请）
  - ✅ 添加加入方式的开关控制
  - ✅ 创建机构邀请管理API路由
  - _需求: 3.1, 3.2, 3.3_

- [x] 6. 创建成员审核系统
  - ✅ 实现成员申请的审核流程
  - ✅ 添加审核权限控制
  - ✅ 实现Q类型会员通过P会员操作的逻辑
  - ✅ 创建审核历史记录功能
  - ✅ 创建机构角色权限系统
  - ✅ 创建角色管理API路由
  - _需求: 3.4, 3.5_

## 阶段四：角色权限体系

- [x] 7. 设计机构角色权限系统
  - ✅ 创建OrganizationRole模型
  - ✅ 实现预设角色清单（创建者、管理员、成员）
  - ✅ 实现18种机构管理权限
  - ✅ 添加自定义角色功能
  - ✅ 创建机构角色管理API路由
  - _需求: 4.1, 4.2, 4.3, 4.4_

- [x] 8. 实现活动角色权限系统
  - ✅ 创建ActivityRole和ActivityParticipantRole模型
  - ✅ 实现15种活动角色（创建人、导游、领队等）
  - ✅ 实现18种活动权限
  - ✅ 添加活动创建人隐身功能
  - ✅ 创建活动角色管理API路由
  - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_

## 阶段五：数据字典管理系统

- [ ] 9. 创建数据字典基础架构
  - 设计DataDictionary模型
  - 实现28种机构分类标签
  - 实现活动角色和机构角色字典
  - 添加字典的动态管理功能
  - _需求: 8.1, 8.2, 8.3, 8.4, 8.5_

- [ ] 10. 实现费用分类字典系统
  - 创建活动收支分类（4种收入+11种支出）
  - 创建个人收支分类（7种收入+16种支出）
  - 创建机构收支分类（6种收入+13种支出）
  - 实现分类的后台管理功能
  - _需求: 8.1, 8.4_

## 阶段六：虚拟币系统

- [ ] 11. 创建虚拟币账户系统
  - 设计QuantumAccount模型
  - 实现用户虚拟币余额管理
  - 创建虚拟币交易记录系统
  - 实现虚拟币的获得和消耗规则
  - _需求: 7.1, 7.2, 7.3, 7.4, 7.5_

- [ ] 12. 实现虚拟币奖励机制
  - 实现新用户注册奖励（1000量子）
  - 实现创建机构奖励（10量子，成员≥5人）
  - 实现发布活动奖励（10量子）
  - 实现观看广告奖励（5量子）
  - 实现记录上传消耗规则
  - _需求: 7.1, 7.2, 7.3, 7.4, 7.5_

## 阶段七：资金管理系统

- [ ] 13. 创建诚信金管理系统
  - 设计TrustDeposit模型
  - 实现5级诚信金退还规则
  - 实现平台托管和原路退回功能
  - 添加诚信金违约处理机制
  - _需求: 6.1_

- [ ] 14. 实现AA费用计算系统
  - 实现复杂的AA费用计算公式
  - 支持个性化参数（K请客/X固定值/D代付）
  - 实现费用分摊的实时计算
  - 添加费用结算和审核功能
  - _需求: 6.2_

- [ ] 15. 创建机构资金管理
  - 设计FinancialAccount模型
  - 实现机构独立资金账户
  - 实现多人审核的提现流程
  - 添加成员赞助功能
  - _需求: 6.3, 6.4_

## 阶段八：权限控制系统

- [ ] 16. 实现细粒度权限控制
  - 创建权限验证中间件
  - 实现基于角色和权限的访问控制
  - 添加前端按钮权限控制
  - 实现权限的实时更新机制
  - _需求: 9.1, 9.2, 9.3, 9.4, 9.5_

- [ ] 17. 创建权限管理界面
  - 实现角色权限分配界面
  - 添加权限继承和冲突检测
  - 实现权限变更的审计日志
  - 创建权限测试和验证工具
  - _需求: 9.1, 9.4_

## 阶段九：前端界面开发

- [ ] 18. 重构团队管理界面为机构管理
  - 更新admin-frontend/teams.html为机构管理界面
  - 重构admin-frontend/js/teams-manager.js
  - 实现多层级机构的树形显示
  - 添加机构类型和标签管理
  - _需求: 2.1, 2.2, 8.1_

- [ ] 19. 创建成员管理界面
  - 实现成员列表和详情页面
  - 添加成员角色权限分配界面
  - 实现成员加入方式的配置界面
  - 创建成员审核工作台
  - _需求: 3.1, 3.4, 4.1_

- [ ] 20. 实现资金管理界面
  - 创建诚信金管理界面
  - 实现AA费用计算和分摊界面
  - 添加机构资金账户管理
  - 创建虚拟币账户和交易记录界面
  - _需求: 6.1, 6.2, 6.3, 7.1_

## 阶段十：多端同步和API完善

- [ ] 21. 完善后端API接口
  - 创建机构管理相关的50个API接口
  - 实现权限验证和数据校验
  - 添加API文档和测试用例
  - 优化API性能和错误处理
  - _需求: 10.1, 10.2, 10.3_

- [ ] 22. 实现小程序端适配
  - 更新jianlu-uniapp/pages/team/team.vue
  - 实现机构功能的移动端界面
  - 添加扫码加入和移动支付功能
  - 确保多端数据同步
  - _需求: 10.1, 10.2, 10.4, 10.5_

## 阶段十一：测试和优化

- [ ] 23. 创建数据迁移和兼容性处理
  - 编写现有团队数据到机构数据的迁移脚本
  - 实现向后兼容的API接口
  - 添加数据完整性检查
  - 创建回滚方案
  - _需求: 所有需求的数据完整性_

- [ ] 24. 系统集成测试和性能优化
  - 编写完整的功能测试用例
  - 进行性能测试和优化
  - 实现系统监控和日志记录
  - 添加错误处理和用户反馈机制
  - _需求: 所有需求的质量保证_