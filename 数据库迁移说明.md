# 数据库迁移说明

本文档详细说明如何在新环境中迁移和配置 kirojianlu 项目的数据库，确保与现有环境功能一致。

## 1. 环境准备

### 1.1 系统要求
- MySQL 8.0 或更高版本
- Node.js 16+（用于执行迁移脚本）
- Windows 或 Linux 操作系统

### 1.2 安装 MySQL
1. 下载并安装 MySQL 8.0+
2. 记录 root 用户密码，后续配置中需要使用

## 2. 数据库迁移步骤

### 2.1 配置环境变量文件
在 `database` 目录下创建 `.env` 文件，内容如下：

```ini
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_NAME=jianlu_admin
DB_USER=root
DB_PASSWORD=你的MySQL根密码
```

### 2.2 执行基础数据库安装
Windows 环境下，双击运行 `database/install.bat` 脚本，或在 PowerShell 中执行：

```powershell
cd database
.\install.bat
```

脚本将自动完成以下操作：
- 创建数据库 `jianlu_admin`
- 创建表结构（用户、团队、活动等核心表）
- 设置应用专用账户（`jianlu_app` 和 `jianlu_readonly`）
- 初始化基础数据（默认管理员账户等）

### 2.3 执行完整迁移（可选但推荐）
为了确保新环境支持所有最新功能，建议执行完整迁移：

```bash
cd database
npm install
npm run migrate -- --all
```

此操作将应用所有数据库变更，包括：
- 活动费用分摊功能
- 微信登录字段扩展
- 团队类型管理
- Banner 管理功能
- 其他后续添加的功能

## 3. 验证迁移结果

### 3.1 检查数据库结构
连接到 MySQL 数据库，验证是否创建了以下关键表：
- users（用户表）
- teams（团队表）
- activities（活动表）
- activity_participants（活动参与者表）
- team_types（团队类型表）
- banners（Banner表）
- activity_expenses（活动费用表）

### 3.2 验证基础数据
检查是否成功插入了默认数据：
- 管理员账户：用户名 `admin`，默认密码 `admin123`
- 系统配置项
- 示例团队数据

### 3.3 验证用户权限
确认是否成功创建了以下数据库用户：
- `jianlu_app`：应用使用的账户，具有完整读写权限
- `jianlu_readonly`：只读账户，用于报表和分析

## 4. 安全注意事项

### 4.1 修改默认密码
安装完成后，请立即修改以下默认密码：
1. 数据库用户密码：
   - `jianlu_app` 用户密码
   - `jianlu_readonly` 用户密码
2. 管理员账户密码：
   - 登录系统后立即修改 `admin` 账户密码

### 4.2 生产环境配置
在生产环境中，还需进行以下配置：
1. 配置防火墙规则，限制数据库访问
2. 设置定期数据库备份策略
3. 根据实际需求调整用户权限

## 5. 常见问题处理

### 5.1 连接失败
- 检查 MySQL 服务是否启动
- 确认 `.env` 文件中的连接参数是否正确
- 验证 MySQL root 密码是否正确

### 5.2 权限不足
- 确保使用的 MySQL 账户具有创建数据库和用户的权限
- 必要时使用具有 SUPER 权限的账户执行 `setup.sql`

### 5.3 字段重复错误
- 如果某些字段已存在，脚本会报错，可手动跳过或删除已存在的字段
- 建议在测试环境中先验证迁移脚本

## 6. 后续维护

### 6.1 数据库升级
当项目有新的数据库变更时，通过以下方式升级：
```bash
cd database
npm run migrate
```

### 6.2 数据备份
定期执行数据库备份：
```bash
mysqldump -u root -p jianlu_admin > backup-$(date +%Y%m%d).sql
```

---
*本文档最后更新日期：2025年10月20日*